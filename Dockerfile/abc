FROM centos:centos7

RUN mkdir -p /opt/nginx/sbin && \
	mkdir -p /opt/nginx/conf && \
	mkdir -p /opt/nginx/log
WORKDIR /usr/local/src

# Install prerequisites for Nginx compile
RUN yum install -y \
        gcc \
		gcc-c++ \
		make \
		zlib-devel \
		pcre-devel \
		openssl-devel \
		wget

# Download Nginx and Nginx modules source
RUN wget http://nginx.org/download/nginx-1.15.0.tar.gz && \
    tar -xzvf nginx-1.15.0.tar.gz && \
	mv nginx-1.15.0 nginx1
# Build Nginx
WORKDIR /usr/local/src
RUN cd nginx1 && \
	./configure \
	--user=nginx \
	--group=nginx \
	--prefix=/opt/nginx \
	--sbin-path=/opt/nginx/sbin/nginx \
	--conf-path=/opt/nginx/conf/nginx.conf \
	--pid-path=/var/run/nginx1.pid \
	--lock-path=/var/run/nginx1.lock \
	--error-log-path=/opt/nginx/log/error.log \
	--http-log-path=/opt/nginx/log/access.log \
	--with-http_gzip_static_module \
	--with-http_stub_status_module \
	--with-http_ssl_module \
	--with-pcre \
	--with-file-aio \
	--with-http_realip_module \
	--without-http_scgi_module \
	--without-http_uwsgi_module \
	--without-http_fastcgi_module && \
    make && \
    make install

WORKDIR /opt/nginx

# Add nginx user
RUN mkdir -p /var/lib/nginx && \
	useradd nginx -d /var/lib/nginx -s /sbin/nologin 

RUN chown -R nginx:nginx /var/lib/nginx

#VOLUME /opt/nginx/host:/opt/nginx
# PORTS
EXPOSE 80
EXPOSE 443

CMD ["/opt/nginx/sbin/nginx", "-g", "daemon off;"]
